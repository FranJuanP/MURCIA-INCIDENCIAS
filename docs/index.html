<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Murcia Incidencias ‚Ä¢ Monitor</title>
  <link rel="icon" href="favicon.ico" />
  <script src="config.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:#101a2e;--text:#e6edf7;--muted:#9bb0cc;--accent:#6ee7ff;--ok:#36d399;--warn:#fbbf24;--bad:#fb7185;}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#081024 0%,#070b16 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{height:100%;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;background:rgba(7,11,22,.92);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.4px}
    .badge{font-size:12px;color:#001018;background:var(--accent);padding:3px 8px;border-radius:999px;font-weight:700}
    .stats{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
    .kpi{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px;min-width:150px}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:800;line-height:1.2}
    main{flex:1;overflow:hidden}
    .grid{max-width:1200px;margin:0 auto;height:100%;padding:14px;display:grid;grid-template-columns:1fr 360px;gap:14px}
    .card{background:rgba(16,26,46,.72);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.35)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.12em}
    .list{height:calc(100% - 44px);overflow:auto}
    .row{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:10px}
    .row:last-child{border-bottom:none}
    .sev{width:10px;border-radius:999px}
    .sev.high{background:var(--bad)}
    .sev.medium{background:var(--warn)}
    .sev.low{background:var(--ok)}
    .meta{flex:1;min-width:0}
    .title{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);margin-top:2px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    .right{width:360px;display:flex;flex-direction:column;gap:14px}
    .sources{padding:10px 12px}
    .src{display:flex;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .src:last-child{border-bottom:none}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.22)}
    .src a{color:var(--text);text-decoration:none}
    .src small{display:block;color:var(--muted)}
    footer{position:fixed;right:14px;bottom:10px;color:rgba(255,255,255,.35);font-size:12px;letter-spacing:.08em}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } .right{display:none} }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="topbar">
      <div class="brand">
        <span>üõ∞Ô∏è Murcia Incidencias</span>
        <span class="badge" id="modeBadge">STATIC</span>
      </div>
      <div class="stats">
        <div class="kpi"><div class="t">Incidencias activas</div><div class="v" id="kpiActive">‚Äî</div></div>
        <div class="kpi"><div class="t">√öltima actualizaci√≥n</div><div class="v" id="kpiUpdated">‚Äî</div></div>
        <div class="kpi"><div class="t">Fuentes</div><div class="v" id="kpiSources">‚Äî</div></div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>Incidencias</h2>
        <div class="list" id="incList"></div>
      </section>

      <aside class="right">
        <section class="card">
          <h2>Fuentes (config)</h2>
          <div class="sources" id="srcList"></div>
        </section>
        <section class="card">
          <h2>Estado</h2>
          <div class="sources">
            <div class="src"><span class="dot"></span><div><a href="#" id="openData">Abrir data/incidents.json</a><small>Archivo servido por GitHub Pages</small></div></div>
            <div class="src"><span class="dot"></span><div><a href="#" id="openStats">Abrir data/stats.json</a><small>KPIs</small></div></div>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <footer>OkrtSystem</footer>
</div>

<script>
  const API_BASE = (window.API_BASE || "").replace(/\/$/, "");
  const DATA_INC = (window.DATA_INCIDENTS || "data/incidents.json");
  const DATA_STATS = (window.DATA_STATS || "data/stats.json");
  const DATA_SOURCES = (window.DATA_SOURCES || "data/sources.json");
  const POLL_MS = (window.POLL_MS !== undefined) ? window.POLL_MS : 15000;

  document.getElementById("modeBadge").textContent = API_BASE ? "API" : "STATIC";
  const url = (p) => API_BASE ? (API_BASE + "/" + p.replace(/^\//,"")) : p;

  document.getElementById("openData").href = url(DATA_INC);
  document.getElementById("openStats").href = url(DATA_STATS);

  const incList = document.getElementById("incList");
  const srcList = document.getElementById("srcList");

  function fmtTime(iso){
    try{ const d = new Date(iso); return d.toLocaleString("es-ES"); }catch{ return iso || "‚Äî" }
  }
  function pill(txt){ return `<span class="pill">${txt}</span>`; }

  function renderIncidents(items){
    incList.innerHTML = "";
    if(!items || !items.length){
      incList.innerHTML = `<div class="row"><div class="meta"><div class="title">Sin incidencias</div><div class="sub">No hay datos en este momento.</div></div></div>`;
      return;
    }
    for(const it of items){
      const sev = (it.severity || "low").toLowerCase();
      const when = it.ts || it.timestamp || it.time;
      const source = (it.source && it.source.name) || it.source_name || it.source || "‚Äî";
      const place = (it.location && it.location.name) || it.location_name || it.place || "";
      const cat = it.category || "otro";
      const href = (it.source && it.source.url) || it.url || it.source_url || null;
      const title = it.title || it.headline || "Incidencia";
      const sub = [pill(cat), place ? pill(place) : "", pill(source), pill(fmtTime(when))].filter(Boolean).join(" ");
      incList.insertAdjacentHTML("beforeend", `
        <div class="row">
          <div class="sev ${sev}"></div>
          <div class="meta">
            <div class="title">${href ? `<a href="${href}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">${title}</a>` : title}</div>
            <div class="sub">${sub}</div>
          </div>
        </div>
      `);
    }
  }

  function renderSources(sources){
    srcList.innerHTML = "";
    for(const s of sources){
      srcList.insertAdjacentHTML("beforeend", `
        <div class="src">
          <span class="dot"></span>
          <div>
            <a href="${s.url || "#"}" target="_blank" rel="noopener">${s.label}</a>
            <small>${s.group}</small>
          </div>
        </div>
      `);
    }
    document.getElementById("kpiSources").textContent = String(sources.length);
  }

  async function loadJSON(path){
    const r = await fetch(url(path), {cache:"no-store"});
    if(!r.ok) throw new Error(`HTTP ${r.status} ${path}`);
    return r.json();
  }

  async function refresh(){
    try{
      const [inc, stats, sources] = await Promise.all([
        loadJSON(DATA_INC),
        loadJSON(DATA_STATS),
        loadJSON(DATA_SOURCES),
      ]);
      renderIncidents(inc.items || inc);
      renderSources(sources.items || sources);
      document.getElementById("kpiActive").textContent = String((stats.active !== undefined) ? stats.active : ((inc.items && inc.items.length) || inc.length || 0));
      document.getElementById("kpiUpdated").textContent = fmtTime(stats.updated_at || stats.updated || new Date().toISOString());
    }catch(e){
      incList.innerHTML = `<div class="row"><div class="meta"><div class="title">Error cargando datos</div><div class="sub">${String(e)}</div></div></div>`;
    }
  }

  refresh();
  setInterval(refresh, POLL_MS);

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
</script>
</body>
</html>
